<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OpenAI SSEæ ¼å¼è§£æå™¨</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
    <div class="header">
        <h1>OpenAI SSEæ ¼å¼è§£æå™¨</h1>
        <p>å°†OpenAIæ ¼å¼çš„SSEè¾“å‡ºç²˜è´´åˆ°å·¦ä¾§ï¼Œå³ä¾§å°†æ˜¾ç¤ºæ ¼å¼åŒ–åçš„æ¶ˆæ¯å†…å®¹å’Œå·¥å…·è°ƒç”¨</p>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header">SSEè¾“å…¥ (åŸå§‹æ•°æ®)</div>
            <div class="panel-content">
                <textarea id="sseInput" placeholder="è¯·ç²˜è´´OpenAIæ ¼å¼çš„SSEè¾“å‡ºå†…å®¹..."></textarea>
            </div>
            <button class="parse-btn" onclick="parseSSE()">è§£æ</button>
        </div>

        <div class="right-panel">
            <div class="panel-header">è§£æç»“æœ</div>
            <div class="panel-content" id="output">
                <div class="empty-state">
                    <h3>ç­‰å¾…è§£æ</h3>
                    <p>è¯·åœ¨å·¦ä¾§ç²˜è´´SSEå†…å®¹å¹¶ç‚¹å‡»"è§£æ"æŒ‰é’®</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function parseSSE() {
            const input = document.getElementById('sseInput').value.trim();
            const output = document.getElementById('output');
            
            if (!input) {
                output.innerHTML = '<div class="empty-state"><h3>è¾“å…¥ä¸ºç©º</h3><p>è¯·ç²˜è´´SSEå†…å®¹</p></div>';
                return;
            }

            try {
                const messages = [];
                const toolCalls = [];
                
                // æŒ‰è¡Œåˆ†å‰²è¾“å…¥
                const lines = input.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // è·³è¿‡ç©ºè¡Œå’Œédataè¡Œ
                    if (!line || !line.startsWith('data: ')) {
                        continue;
                    }
                    
                    // æå–JSONæ•°æ®
                    const jsonStr = line.substring(6); // ç§»é™¤ "data: " å‰ç¼€
                    
                    // è·³è¿‡ [DONE] æ ‡è®°
                    if (jsonStr === '[DONE]') {
                        continue;
                    }
                    
                    try {
                        const data = JSON.parse(jsonStr);
                        
                        if (data.choices && data.choices[0]) {
                            const choice = data.choices[0];
                            const delta = choice.delta;
                            
                            if (delta) {
                                // å¤„ç†æ¶ˆæ¯å†…å®¹
                                if (delta.content) {
                                    let lastMessage = messages[messages.length - 1];
                                    if (!lastMessage || lastMessage.role !== (delta.role || 'assistant')) {
                                        messages.push({
                                            role: delta.role || 'assistant',
                                            content: delta.content
                                        });
                                    } else {
                                        lastMessage.content += delta.content;
                                    }
                                }
                                
                                // å¤„ç†å·¥å…·è°ƒç”¨
                                if (delta.tool_calls) {
                                    delta.tool_calls.forEach(toolCall => {
                                        let existingCall = toolCalls.find(tc => tc.id === toolCall.id);
                                        if(!toolCall.id){
                                            existingCall = toolCalls[toolCalls.length-1];
                                        }
                                        if (!existingCall) {
                                            toolCalls.push({
                                                id: toolCall.id,
                                                type: toolCall.type || 'function',
                                                function: {
                                                    name: toolCall.function?.name || '',
                                                    arguments: toolCall.function?.arguments || ''
                                                }
                                            });
                                        } else {
                                            if (toolCall.function?.name) {
                                                existingCall.function.name += toolCall.function.name;
                                            }
                                            if (toolCall.function?.arguments) {
                                                existingCall.function.arguments += toolCall.function.arguments;
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    } catch (parseError) {
                        console.warn('è§£æJSONå¤±è´¥:', parseError, 'åŸå§‹æ•°æ®:', jsonStr);
                    }
                }
                
                // ç”Ÿæˆè¾“å‡ºHTML
                let html = '';
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                if (messages.length > 0) {
                    html += '<div class="output-section">';
                    html += '<div class="section-header">ğŸ“ æ¶ˆæ¯å†…å®¹</div>';
                    html += '<div class="section-content">';
                    
                    messages.forEach((message, index) => {
                        html += '<div class="message-item">';
                        html += `<div class="message-role">${message.role}:</div>`;
                        html += `<div class="message-content">${escapeHtml(message.content)}</div>`;
                        html += '</div>';
                    });
                    
                    html += '</div></div>';
                }
                
                // æ˜¾ç¤ºå·¥å…·è°ƒç”¨
                if (toolCalls.length > 0) {
                    html += '<div class="output-section">';
                    html += '<div class="section-header">ğŸ”§ å·¥å…·è°ƒç”¨</div>';
                    html += '<div class="section-content">';
                    
                    toolCalls.forEach((toolCall, index) => {
                        html += '<div class="tool-call">';
                        
                        // å·¥å…·å¤´éƒ¨ä¿¡æ¯
                        html += '<div class="tool-header">';
                        html += `<span class="tool-name">ğŸ”§ ${escapeHtml(toolCall.function.name)}</span>`;
                        if (toolCall.id) {
                            html += `<span class="tool-id">(ID: ${escapeHtml(toolCall.id)})</span>`;
                        }
                        html += '</div>';
                        
                        // å‚æ•°éƒ¨åˆ†
                        if (toolCall.function.arguments) {
                            html += '<div class="tool-args-label">å‚æ•°:</div>';
                            try {
                                const args = JSON.parse(toolCall.function.arguments);
                                html += '<div class="tool-args">';
                                html += escapeHtml(JSON.stringify(args, null, 4));
                                html += '</div>';
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
                                html += '<div class="tool-args">';
                                html += escapeHtml(toolCall.function.arguments);
                                html += '</div>';
                            }
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div></div>';
                }
                
                if (messages.length === 0 && toolCalls.length === 0) {
                    html = '<div class="empty-state"><h3>æœªæ‰¾åˆ°å†…å®¹</h3><p>è¾“å…¥çš„SSEæ•°æ®ä¸­æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯æˆ–å·¥å…·è°ƒç”¨</p></div>';
                }
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<div class="empty-state"><h3>è§£æé”™è¯¯</h3><p>é”™è¯¯è¯¦æƒ…: ${escapeHtml(error.message)}</p></div>`;
                console.error('è§£æSSEæ—¶å‡ºé”™:', error);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨è§£æ
        document.getElementById('sseInput').addEventListener('input', function() {
            const input = this.value.trim();
            if (input && input.includes('data: ')) {
                // å»¶è¿Ÿè§£æï¼Œé¿å…é¢‘ç¹è§¦å‘
                clearTimeout(this.parseTimeout);
                this.parseTimeout = setTimeout(parseSSE, 500);
            }
        });
    </script>
    <script>
        (function () {
         var wb = window.whistleBridge;
         var $out = document.getElementById('sseInput');
     
         function put(text) { $out.value = text == null ? '' : String(text); }
     
         async function renderSelected() {
             var { res } = await wb.getSelectedSession() || {};
             if (!res) return put('æœªè·å–åˆ°é€‰ä¸­è¯·æ±‚ï¼Œè¯·åœ¨ Network é‡Œç‚¹é€‰ä¸€æ¡è®°å½•');
             // åˆ¤æ–­ä¸€ä¸‹è¯·æ±‚å¤´æ˜¯å¦æ˜¯ sse ç±»å‹çš„ï¼Œå¦‚æœåŒ¹é…åˆ° content-type çš„è¯
             const headers = res.headers;
             const contentType = headers['content-type'];
             if (contentType && contentType.includes('text/event-stream')) {
                const body = wb.decodeBase64(res.base64);
                const text = body.text;
                put(text);
             }else{
                put('é SSE å“åº”');
             }
         }
     
         if (!wb) return put('whistleBridge ä¸å¯ç”¨ï¼ˆè¯·åœ¨ Whistle çš„ Network è¯¦æƒ…é¢æ¿å†…æ‰“å¼€ï¼‰');
     
         // é¦–æ¬¡æ¸²æŸ“
         renderSelected();
     
         // å“åº”åˆ°è¾¾/å®Œæˆæˆ–é€‰ä¸­å˜åŒ–æ—¶åˆ·æ–°
         wb.addSessionResponseListener && wb.addSessionResponseListener(function (e) { renderSelected(); });
         wb.addSessionCompleteListener && wb.addSessionCompleteListener(function (e) { renderSelected(); });
         wb.addSessionActiveListener && wb.addSessionActiveListener(function (e) { renderSelected(); });
         })();
       </script>
</body>
</html>


